<% if !@activity.photo_url.nil? %>
  <div class="map" style="background-image: url('<%= @activity.photo_url %>')"></div>
<% else %>
  <div class="map" style="background-image: url('<%=cl_image_path @activity.photo.key, crop: :fill %>')"></div>
<% end %>
<div class="container margin-top-negative">
  <div class="row">
    <div class="col-12 col-lg-8">
      <div class="card shadow">
        <h2 class="card-header"><%= @activity.title %></h2>
        <div class="card-body d-flex justify-content-between align-items-center">
          <p class="card-text m-0"><i class="fa-solid fa-location-dot"></i> <%= @activity.location %></p>
          <p class="card-text">Up to <strong><%= @activity.max_people %></strong> people </p>
        </div>
      </div>
      <div class="card shadow mb-2 p-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class= "d-flex justify-content-start align-items-center">
            <% if @provider.photo.attached? %>
              <%= cl_image_tag @provider.photo.key, class: "avatar me-4" %>
            <% else %>
              <img class="avatar me-4", src="https://res.cloudinary.com/dp39nvrov/image/upload/v1701160462/no_profile_pic_mygech.png" />
            <% end %>
            <p class="card-text m-0"><%= @activity.user.first_name %> -
            <%# Get average rating %>
            <% if @activity.reviews.present? %>
            <% average_rating = @activity.reviews.average(:rating).to_f %>
            <%= "%.1f" % average_rating %>
            <i class="fa-solid fa-star text-warning"></i>
            <% else %>
             New
            <% end %>
              <%# Get average rating %>
              <%# <% if @activity.reviews.empty? %>
                <%# No reviews yet
              <% else %>
                <%# <%= (@activity.reviews.pluck(:rating).sum / @activity.reviews.pluck(:rating).length).round(1) %>
                <%# <i class="fa-solid fa-star text-warning"></i>
              <% end %>
            </p>
          </div>
          <div>
            <p class="m-0 fst-italic">#<%=@activity.category.name.downcase%></p>
          </div>
        </div>
      </div>
      <div class="card shadow my-4 p-0">
        <h4 class="card-header">Know more about this experience</h4>
        <div class="card-body d-flex justify-content-start align-items-center">
          <p class="card-text m-0"><%= Faker::Lorem.paragraphs(number: 8).join(" ") %></p>
        </div>
      </div>
      <div class="card shadow my-4 p-0">
        <h4 class="card-header">Where is this experience taking place?</h4>
        <div class="card-body d-flex justify-content-start align-items-center">
          <div style="width: 100%; height: 600px;"
            data-controller="map"
            data-map-markers-value="<%= @markers.to_json %>"
            data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow sticky-top">
        <h2 class="card-header">Book now!</h2>
        <div class="card-body">
          <%= simple_form_for [@activity, @booking] do |f| %>
            <div data-controller="timeslots" data-timeslots-id-value="<%= @activity.id %>">
            <%= f.input :day,
                        as: :string,
                        input_html: { data: { controller: "datepicker", action: "change->timeslots#dateChange" } } %>
            <div data-timeslots-target="slots">
            <fieldset class="mb-3 radio_buttons optional booking_time_slot"><legend class="col-form-label pt-0">Time slot</legend><input type="hidden" name="booking[time_slot_id]" value="" autocomplete="off"></fieldset>
            </div>
            <%= f.input :number_of_people%>
            <%= f.hidden_field :property_id, value: @property.id if !@property.nil?%>
            <%= f.submit class: 'btn btn-primary' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row my-4">
    <div class="col-12 col-lg-8">
      <div class="card shadow">
        <h2 class="card-header">Reviews</h2>
          <% @activity.reviews.each do |review| %>
            <div class="card-body d-flex pb-0 border-bottom">
              <div class="d-flex flex-column">
                  <% if review.user.photo.attached? %>
                  <%= cl_image_tag review.user.photo.key, class: "avatar" %>
                <% else %>
                  <img class="avatar", src="https://res.cloudinary.com/dp39nvrov/image/upload/v1701160462/no_profile_pic_mygech.png" />
                <% end %>
                <p class="text-center"><%= review.user.first_name %></p>
              </div>
              <div class="d-flex flex-column ms-3">
                <div><p><%= review.rating %><i class="fas fa-star star-yellow"></i></p></div>
                <div><p><%= review.comment %></p></div>
              </div>
          </div>
        <% end %>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow">
        <h2 class="card-header">Leave a review</h2>
        <div class="card-body">
          <%# <%= simple_form_for([@activity, @review], property_id: 45) do |f| %>
          <%= simple_form_for(@review, as: :review, method: :post, url: activity_reviews_path(@activity, property_id: params[:property_id])) do |f| %>
            <%= f.input :comment,
                        as: :string %>
            <%= f.input :rating,
                        as: :float %>
            <%= f.submit class: 'btn btn-primary' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<%#
<% if params[:property_id].present? %>
<%# <%= link_to "Back to all recommendations", property_recommendations_path(params[:property_id]), class: "btn btn-dark-green" %>
<%# <% end %>

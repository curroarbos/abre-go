<div class="container py-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Explore All Activities</h3>
  </div>
  <div class="row justify-content-center">
    <div class="col-sm-8 my-3">
      <%= form_with url: activities_path, method: :get, class: "d-flex" do |form| %>
        <%= form.hidden_field :property_id, value: params[:property_id] %>
        <%= form.text_field :query,
              value: params[:query],
              class: "form-control",
              placeholder: "Search by activity name or category (e.g. 'food', 'music', 'outdoors')"
          %>
        <%= submit_tag "Search", name: "", class: "btn btn-dark-green" %>
      <% end %>
    </div>
  </div>
  <div class="mb-3">
    <div class="row my-2">
    <div class="col-12 col-lg-8">
      <div class="cards">
      <% @activities.each do | activity | %>
        <div class="mb-3">
          <%= link_to activity_path(activity, property_id: @property || params[:property_id]), class: "text-decoration-none text-dark" do %>
            <% if !activity.photo_url.nil?  %>
            <div class="card-category">
              <%= image_tag activity.photo_url, alt: "text", style: "background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3))", data: {aos: "zoom-in"}, loading: "lazy" %>
            </div>
          <% else %>
            <div class="card-category">
              <%= cl_image_tag activity.photo.key, height: 300, crop: :fill , alt: "text", style: "background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3))", data: {aos: "zoom-in"}, loading: "lazy" %>
            </div>
          <% end %>
            <div class="p-3 rounded-bottom d-flex flex-column">
              <div class="d-flex justify-content-between">
                <h4> <%= activity.title %> </h4>
                <p class="text-muted font-weight-normal">
                <%# Old code %>
                <%# <% if activity.reviews.empty? %>
                  <%# No reviews yet %>
                <%# <% else %>
                  <%# <%= (activity.reviews.pluck(:rating).sum / activity.reviews.pluck(:rating).length).round(1) %>
                  <%# <i class="fa-solid fa-star text-warning"></i> %>
                <%# <% end %>
                 <%# Get average rating %>
                 <% if activity.reviews.present? %>
                  <% average_rating = activity.reviews.average(:rating).to_f %>
                  <%= "%.1f" % average_rating %>
                  <i class="fas fa-star star-yellow"></i>
                 <% else %>
                    New
                 <% end %>
                </p>
              </div>
              <p> <%= activity.location %> </p>
              <p> <strong><%= activity.price %> â‚¬ </strong></p>
            </div>
          <% end %>
          </div>
        <% end %>
        </div>
      </div>
      <div class="class col-12 col-lg-4">
      <div class="card-body d-flex justify-content-start align-items-center my-2">
        <div style="width: 100%; height: 600px;"
          data-controller="map"
          data-map-markers-value="<%= @markers.to_json %>"
          data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
        </div>
        </div>
      </div>
    </div>
  </div>
</div>
